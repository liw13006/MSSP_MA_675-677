---
title: "Fidelity_Project"
author: "Weiling Li"
date: "10/17/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(pracma,lubridate,tidyverse,dplyr,corrplot)
``` 

# Sector Fund

For this project sector fund [Fidelity Select Technology Portfolio (FSPTX)](https://fundresearch.fidelity.com/mutual-funds/summary/316390202) is chosen as the target fund. On Fidelity's website, this is categorized as: *Large Growth*

For comparison, `Russel2000(^RUT)`, `NASDAQ(^IXIC)`, `S&P500(^GSPC)`, `S&PMidCap(^MID)` and `S&PSmlCap(^SML)` was selected as initial indexes to be campared with.

for comparison, Vanguard's similar index funds are also loaded as `IT ETF(VGT)`,`LargeCap ETF(VIGAX)` and `TotalMarket ETF(VTSAX)`

Before loading data, we will define some useful function to ease the data cleaning process, and claim some variables 1st.
```{r}
## this function requires a dataframe input that has the daily close price named:Closed and a date column named: Date with format as: floating point and "xxxx(year)-xx(month)-xx(day)"
## We trimmed the data from 1990-10-07 because 1990-10-08 is a Monday and Stock market closed during weekend
dailynlogReturn <- function(Date1,DataFrame){
  DataFrame = mutate(DataFrame, dailyReturn = (Close-lag(Close))/Close)%>%mutate(perc_dailyRe = round(dailyReturn*100.0,3))%>%mutate(log.Close = log(Close))%>%filter(Date >= Date1)%>%filter(Date <= as.Date("2018-12-31"))
}
## This function returns a projection value of the fund from the start date and assuming 10k investment from the start and reinvest all earnings
getProjectionValue <- function(DF){
  P0 = pull(filter(DF, Date == pull(top_n(DF["Date"],-1)))%>%select(Close))
  DF = mutate(DF,ProjValper10k = (Close*10000)/P0)
}
## Calculate Euclidean distances between two sets of data
sqerr <- function(x,y){
  z = x - y
  z = sqrt(dot(z,z)/length(y))
  return(z)
}

## function for standarize NAV
standardizedNAV = function(DF){
  return(mutate(DF,Close.z = (Close-mean(Close))/sd(Close)))
}

## restrict ourselves to study data after 2014-01-01
StartDate = as.Date("2014-01-01")

```

## Load and clean the data, then some EDA
Load the data:

```{r,message = FALSE}
FSPTX = dailynlogReturn(StartDate,read_csv("FSPTX.csv"))
NASDAQ = dailynlogReturn(StartDate,read_csv("^IXIC.csv"))
SnP500 = dailynlogReturn(StartDate,read_csv("^GSPC.csv"))
SnPMID = dailynlogReturn(StartDate,read_csv("^MID.csv"))
SnPSML = dailynlogReturn(StartDate,read_csv("^SML.csv"))
RUSSELL2000 = dailynlogReturn(StartDate,read_csv("^RUT.csv"))
VGT = dailynlogReturn(StartDate,read_csv("VGT.csv"))
VIGAX = dailynlogReturn(StartDate,read_csv("VIGAX.csv"))
VTSAX = dailynlogReturn(StartDate,read_csv("VTSAX.csv"))
```

Standardize NAV

```{r}
FSPTX = standardizedNAV(FSPTX)
NASDAQ = standardizedNAV(NASDAQ)
SnP500 = standardizedNAV(SnP500)
SnPMID = standardizedNAV(SnPMID)
SnPSML = standardizedNAV(SnPSML)
RUSSELL2000 = standardizedNAV(RUSSELL2000)
VGT = standardizedNAV(VGT)
VIGAX = standardizedNAV(VIGAX)
VTSAX = standardizedNAV(VTSAX)
```

Plot the NAVs:

```{r}
ggplot(FSPTX)+ theme(legend.position="top")+geom_line(mapping = aes(x = Date,y = Close.z,color = "FSPTX"))+geom_line(mapping = aes(x = NASDAQ$Date,y = NASDAQ$Close.z,color = "NASDAQ"),alpha = .4)+geom_line(mapping = aes(x = SnPMID$Date,y = SnPMID$Close.z,color = "S&PmidCAP"),alpha = .4)+geom_line(mapping = aes(x = SnPSML$Date,y = SnPSML$Close.z,color = "S&PsmlCAP"),alpha = .4)+geom_line(mapping = aes(x = RUSSELL2000$Date,y = RUSSELL2000$Close.z,color = "Russell2000"),alpha = .4)+ylab("standardized NAV")
```

For comparison, plot Vanguard's fund too

```{r}
ggplot(VGT)+geom_line(mapping = aes(x = Date,y = Close.z,color = "VGT"))+geom_line(mapping = aes(x = NASDAQ$Date,y = NASDAQ$Close.z,color = "NASDAQ"),alpha = .4)+geom_line(mapping = aes(x = SnPMID$Date,y = SnPMID$Close.z,color = "S&PmidCAP"),alpha = .4)+geom_line(mapping = aes(x = SnPSML$Date,y = SnPSML$Close.z,color = "S&PsmlCAP"),alpha = .4)+geom_line(mapping = aes(x = RUSSELL2000$Date,y = RUSSELL2000$Close.z,color = "Russell2000"),alpha = .4)+ylab("standardized NAV")+ theme(legend.position="top")

ggplot(VIGAX)+geom_line(mapping = aes(x = Date,y = Close.z,color = "VIGAX"))+geom_line(mapping = aes(x = NASDAQ$Date,y = NASDAQ$Close.z,color = "NASDAQ"),alpha = .4)+geom_line(mapping = aes(x = SnPMID$Date,y = SnPMID$Close.z,color = "S&PmidCAP"),alpha = .4)+geom_line(mapping = aes(x = SnPSML$Date,y = SnPSML$Close.z,color = "S&PsmlCAP"),alpha = .4)+geom_line(mapping = aes(x = RUSSELL2000$Date,y = RUSSELL2000$Close.z,color = "Russell2000"),alpha = .4)+ylab("standardized NAV")+ theme(legend.position="top")

ggplot(VTSAX)+geom_line(mapping = aes(x = Date,y = Close.z,color = "VTSAX"))+geom_line(mapping = aes(x = NASDAQ$Date,y = NASDAQ$Close.z,color = "NASDAQ"),alpha = .4)+geom_line(mapping = aes(x = SnPMID$Date,y = SnPMID$Close.z,color = "S&PmidCAP"),alpha = .4)+geom_line(mapping = aes(x = SnPSML$Date,y = SnPSML$Close.z,color = "S&PsmlCAP"),alpha = .4)+geom_line(mapping = aes(x = RUSSELL2000$Date,y = RUSSELL2000$Close.z,color = "Russell2000"),alpha = .4)+ylab("standardized NAV")+ theme(legend.position="top")
```

It seems that the Vanguard's ETF's are more correlated to the indexes. Another way to look at this is the correlation matrix:

```{r}
cordat = cbind(FSPTX$Close.z,NASDAQ$Close.z,SnP500$Close.z,RUSSELL2000$Close.z,SnPMID$Close.z,SnPSML$Close.z,VGT$Close.z,VIGAX$Close.z,VTSAX$Close.z)
DailyReturncor = cbind(FSPTX$dailyReturn,NASDAQ$dailyReturn,SnP500$dailyReturn,RUSSELL2000$dailyReturn,SnPMID$dailyReturn,SnPSML$dailyReturn,VGT$dailyReturn,VIGAX$dailyReturn,VTSAX$dailyReturn)
colnames(DailyReturncor) = c("FSPTX","NASDAQ","SnP500","RUSSELL2000","SnPMID","SnPSML","VGT(IT ETF)","VIGAX(LargeCAP)","VTSAX(TotalMarket)")
DailyReturncor = data.frame(DailyReturncor)
colnames(cordat) = c("FSPTX","NASDAQ","SnP500","RUSSELL2000","SnPMID","SnPSML","VGT(IT ETF)","VIGAX(LargeCAP)","VTSAX(TotalMarket)")
cordat = data.frame(cordat)
print("Nav Correlation")
cor(cordat,cordat)

```

```{r}
print("DailyReturn Correlation")
cor(DailyReturncor,DailyReturncor)
```

Also we can check the corrplot of the cor matrix.

```{r}
colmat <- colorRampPalette(c("red", "white", "blue"))

corrplot(cor(cordat,cordat),cl.lim = c(0.9,1.0),is.corr = FALSE,col = colmat(200),title = "NAV cor",type = "lower",tl.cex = .8)

corrplot(cor(DailyReturncor,DailyReturncor),cl.lim = c(0.6,1.0),is.corr = FALSE,col = colmat(100),title = "DailyReturn cor",type = "lower",tl.cex = .8)

```

It seems that the Fidelity fund is not really matching the indexes we chose.   

Check the dailyreturn and project value

```{r,message=FALSE}
FSPTX = getProjectionValue(FSPTX)
NASDAQ = getProjectionValue(NASDAQ)
SnP500 = getProjectionValue(SnP500)
VGT = getProjectionValue(VGT)
VIGAX = getProjectionValue(VIGAX)
VTSAX = getProjectionValue(VTSAX)
SnPMID = getProjectionValue(SnPMID)
SnPSML = getProjectionValue(SnPSML)
RUSSELL2000 = getProjectionValue(RUSSELL2000)
```

Plot them:

```{r}
ggplot()+geom_line(mapping = aes(x = FSPTX$Date,y = FSPTX$ProjValper10k,color = 'FSPTX'))+geom_line(mapping = aes(x = NASDAQ$Date,y = NASDAQ$ProjValper10k,color = 'NASDAQ'),size = 1.5,alpha = .6)+geom_line(mapping = aes(x = SnP500$Date,y = SnP500$ProjValper10k,color = 'S&P500'),size = 1.5,alpha = .6)+geom_line(mapping = aes(x = VGT$Date,y = VGT$ProjValper10k,color = 'VGT(ITsecETF)'),size = 1,alpha = .2)+geom_line(mapping = aes(x = VIGAX$Date,y = VIGAX$ProjValper10k,color = 'VIGAX(LARGECAPGROWTH)'),size = 1,alpha = .2)+geom_line(mapping = aes(x = VTSAX$Date,y = VTSAX$ProjValper10k,color = 'VTSAX(TOTALSTOCK)'),size = 1,alpha = .2)+geom_line(mapping = aes(x = SnPMID$Date,y = SnPMID$ProjValper10k,color = 'S&PmidCAP'),size = 1,alpha = .2)+geom_line(mapping = aes(x = SnPSML$Date,y = SnPSML$ProjValper10k,color = 'S&PsmlCAP'),size = 1,alpha = .2)+xlab("Date")+ylab("HypoGrowth of 10,000")+ theme(legend.position="top")
```

Still not a good fit...

---

*Below is just some misc works: Mainly exploring the daily return*

```{r}
## Check distance between projected returns
print("pointwise variance between taget fund and NASDAQ")
print(sqerr(FSPTX$ProjValper10k,NASDAQ$ProjValper10k))
#ks.test()
print("pointwise variance between taget fund and S&P500")
print(sqerr(FSPTX$ProjValper10k,SnP500$ProjValper10k))
print("pointwise variance between taget fund and IT sector ETF")
print(sqerr(FSPTX$ProjValper10k,VGT$ProjValper10k))
print("pointwise variance between taget fund and Large cap growth index fund")
print(sqerr(FSPTX$ProjValper10k,VIGAX$ProjValper10k))
print("pointwise variance between taget fund and Total Stock market index fund")
print(sqerr(FSPTX$ProjValper10k,VTSAX$ProjValper10k))
#ggplot(FSPTX)+aes(x = Date , y=perc_dailyRe) + geom_line()

## Compare daily returns
dailyReturnComp = cbind(as.Date(FSPTX$Date),FSPTX$dailyReturn,NASDAQ$dailyReturn,SnP500$dailyReturn,VGT$dailyReturn,VIGAX$dailyReturn,VTSAX$dailyReturn)
colnames(dailyReturnComp) = c("Date","FSPTX","NASDAQ","SnP500","VGT","VIGAX","VTSAX")
epsilon = 0.000000000000000001
dailyReturnComp = data.frame(dailyReturnComp)%>%mutate(Date = as_date(Date),vsNASDAQ = ifelse(NASDAQ*NASDAQ<=epsilon,FSPTX,FSPTX/NASDAQ),vsSnP500 = ifelse(SnP500*SnP500<=epsilon,FSPTX,FSPTX/SnP500),vsVGT = ifelse(VGT*VGT<=epsilon,FSPTX,FSPTX/VGT),vsVIGAX = ifelse(VIGAX*VIGAX<=epsilon,FSPTX,FSPTX/VIGAX),vsVTSAX = ifelse(VTSAX*VTSAX<=epsilon,FSPTX,FSPTX/VTSAX))%>%mutate(minusNASDAQ = FSPTX-NASDAQ,minusSnP500 = FSPTX-SnP500,minusVGT = FSPTX-VGT,minusVIGAX= FSPTX-VIGAX,minusVTSAX = FSPTX-VTSAX)

print("Average ratio of dailyReturn(FSPTX/NASDAQ")
print(sum(sqrt(dailyReturnComp$vsNASDAQ*dailyReturnComp$vsNASDAQ)/length(dailyReturnComp$vsNASDAQ)))
print("Average ratio of dailyReturn(FSPTX/S&P500")
print(sum(sqrt(dailyReturnComp$vsSnP500*dailyReturnComp$vsSnP500)/length(dailyReturnComp$vsSnP500)))
print("Average ratio of dailyReturn(FSPTX/VGT")
print(sum(sqrt(dailyReturnComp$vsVGT*dailyReturnComp$vsVGT)/length(dailyReturnComp$vsVGT)))
print("Average ratio of dailyReturn(FSPTX/VIGAX")
print(sum(sqrt(dailyReturnComp$vsVIGAX*dailyReturnComp$vsVIGAX)/length(dailyReturnComp$vsVIGAX)))
print("Average ratio of dailyReturn(FSPTX/NASDAQ")
print(sum(sqrt(dailyReturnComp$vsVTSAX*dailyReturnComp$vsVTSAX)/length(dailyReturnComp$vsVTSAX)))

dailyReturnSTD = select(dailyReturnComp,contains("minus"))%>%summarise_all(funs(sd))
ggplot(dailyReturnComp)+aes(x = Date,y = minusNASDAQ)+geom_point(alpha = .1)+geom_smooth(method = "loess",se = TRUE)
ggplot(dailyReturnComp)+aes(x = Date,y = minusSnP500)+geom_point(alpha = .1)+geom_smooth(method = "loess",se = TRUE)
ggplot(dailyReturnComp)+aes(x = Date,y = minusVGT)+geom_point(alpha = .1)+geom_smooth(method = "loess",se = TRUE)
ggplot(dailyReturnComp)+aes(x = Date,y = minusVIGAX)+geom_point(alpha = .1)+geom_smooth(method = "loess",se = TRUE)
ggplot(dailyReturnComp)+aes(x = Date,y = minusVTSAX)+geom_point(alpha = .1)+geom_smooth(method = "loess",se = TRUE)
ggplot(dailyReturnComp)+aes(x = FSPTX,y = NASDAQ)+geom_point()+xlim(c(-0.15,0.15))+ylim(c(-0.15,0.15))+geom_abline(intercept = 0.0,slope = 1.0)
ggplot(dailyReturnComp)+aes(x = FSPTX,y = SnP500)+geom_point()+xlim(c(-0.15,0.15))+ylim(c(-0.15,0.15))+geom_abline(intercept = 0.0,slope = 1.0)
ggplot(dailyReturnComp)+aes(x = FSPTX,y = VGT)+geom_point()+xlim(c(-0.15,0.15))+ylim(c(-0.15,0.15))+geom_abline(intercept = 0.0,slope = 1.0)
ggplot(dailyReturnComp)+aes(x = FSPTX,y = VIGAX)+geom_point()+xlim(c(-0.15,0.15))+ylim(c(-0.15,0.15))+geom_abline(intercept = 0.0,slope = 1.0)
ggplot(dailyReturnComp)+aes(x = FSPTX,y = VTSAX)+geom_point()+xlim(c(-0.15,0.15))+ylim(c(-0.15,0.15))+geom_abline(intercept = 0.0,slope = 1.0)
```

